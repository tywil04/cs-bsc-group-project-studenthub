generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String            @id @unique @default(cuid())
  username             String            @unique
  email                String            @unique
  studentEmail         String            @unique
  firstName            String
  lastName             String
  password             String
  studentStatus        UserStudentStatus @default(unverified)
  emailStatus          UserEmailStatus   @default(unverified)
  courses              Course[]
  posts                Post[]
  comments             Comment[]
  reports              Report[]
  relations            UserRelation[]    @relation("user1")
  incomingRelations    UserRelation[]    @relation("user2")
  sessions             Session[]
  emailChallenges      EmailChallenge[]
  profileAboutMe       String?
  images               Image[]
  postReactions        PostReaction[]
  commentReactions     CommentReaction[]
}

model EmailChallenge {
  id      String               @id @unique @default(cuid())
  user    User                 @relation(fields: [userId], references: [id])
  userId  String 
  code    String
  status  EmailChallengeStatus @default(incomplete)
  expires DateTime             @default(now())
  type    EmailChallengeType
}

model Session {
  id      String      @id @unique @default(cuid())
  token   String      @unique
  user    User?       @relation(fields: [userId], references: [id])
  userId  String?
  staff   Staff?      @relation(fields: [staffId], references: [id])
  staffId String?     
  type    SessionType @default(user)
}

model University {
  id      String   @id @unique @default(cuid())
  name    String
  domain  String   @unique // domain of universitys website
  courses Course[]
}

model Course {
  id           String       @id @unique @default(cuid())
  name         String
  level        CourseLevel
  startDate    DateTime
  endDate      DateTime
  status       CourseStatus
  university   University   @relation(fields: [universityId], references: [id])
  universityId String
  user         User         @relation(fields: [userId], references: [id])
  userId       String
}

model Post {
  id        String     @id @unique @default(cuid())
  content   String
  author    User       @relation(fields: [authorId], references: [id])
  authorId  String
  postedAt  DateTime   @default(now())
  images    Image[]
  comments  Comment[]
  tags      PostTag[]
  reports   Report[]
  status    PostStatus @default(unreviewed)
  reactions PostReaction[]
}

model Image {
  id       String      @id @unique @default(cuid())
  type     ImageType   @default(post)
  status   ImageStatus @default(unreviewed)
  data     Bytes
  mimeType String
  post     Post?       @relation(fields: [postId], references: [id])
  postId   String?
  user     User?       @relation(fields: [userId], references: [id])
  userId   String?
  addedAt  DateTime    @default(now())
}

model Comment {
  id              String      @id @unique @default(cuid())
  content         String
  author          User        @relation(fields: [authorId], references: [id])
  authorId        String
  post            Post?       @relation(fields: [postId], references: [id])
  postId          String?
  parentComment   Comment?    @relation("comment", fields: [parentCommentId], references: [id])
  parentCommentId String?
  comments        Comment[]   @relation("comment")
  type            CommentType @default(post)
  commentedAt     DateTime    @default(now())
  reactions       CommentReaction[]
}

model Tag {
  id    String    @id @unique @default(cuid())
  name  String    @unique
  posts PostTag[]
}

model Report {
  id     String     @id @unique @default(cuid())
  type   ReportType
  post   Post       @relation(fields: [postId], references: [id])
  postId String
  user   User       @relation(fields: [userId], references: [id])
  userId String
}

model PostTag {
  post   Post   @relation(fields: [postId], references: [id])
  postId String
  tag    Tag    @relation(fields: [tagId], references: [id])
  tagId  String

  @@id(name: "id", fields: [postId, tagId]) // combined primary key
}

model PostReaction {
  post   Post             @relation(fields: [postId], references: [id])
  postId String
  user   User             @relation(fields: [userId], references: [id])
  userId String
  type   PostReactionType

  @@id(name: "id", fields: [postId, userId, type]) // combined primary key
}

model CommentReaction {
  comment   Comment       @relation(fields: [commentId], references: [id])
  commentId String
  user   User             @relation(fields: [userId], references: [id])
  userId String
  type   CommentReactionType

  @@id(name: "id", fields: [commentId, userId, type]) // combined primary key
}

model UserRelation {
  user1   User             @relation("user1", fields: [user1Id], references: [id])
  user1Id String
  user2   User             @relation("user2", fields: [user2Id], references: [id])
  user2Id String
  type    UserRelationType

  @@id(name: "id", fields: [user1Id, user2Id]) // combined primary key
}

model Staff {
  id                String             @id @unique @default(cuid())
  username          String             @unique
  firstName         String
  lastName          String
  password          String
  announcements     Announcement[]
  accomodationPosts AccomodationPost[]
  jobPosts          JobPost[]
  dealPosts         DealPost[]
  sessions          Session[]
}

model Announcement {
  id       String   @id @unique @default(cuid())
  title    String   @unique
  content  String
  author   Staff    @relation(fields: [authorId], references: [id])
  authorId String
  postedAt DateTime @default(now())
}

model AccomodationPost {
  id          String   @id @unique @default(cuid())
  description String
  location    String
  price       String
  url         String
  author      Staff    @relation(fields: [authorId], references: [id])
  authorId    String
  postedAt    DateTime @default(now())
}

model JobPost {
  id          String   @id @unique @default(cuid())
  description String
  location    String
  pay         String
  url         String
  author      Staff    @relation(fields: [authorId], references: [id])
  authorId    String
  postedAt    DateTime @default(now())
}

model DealPost {
  id       String   @id @unique @default(cuid())
  offer    String
  url      String
  author   Staff    @relation(fields: [authorId], references: [id])
  authorId String
  postedAt DateTime @default(now())
}

enum UserStudentStatus {
  unverified
  verified
}

enum UserEmailStatus {
  unverified
  verified
}

enum PostReactionType {
  liked 
  disliked
}

enum CommentReactionType {
  liked 
  disliked
}

enum UserRelationType {
  followed
  blocked
}

enum CommentType {
  post 
  comment
}

enum CourseLevel {
  undergraduate
  postgraduate
}

enum CourseStatus {
  active
  finished // this is pass or fail or dropout
}

enum PostStatus {
  unreviewed
  allowed
  blocked
}

enum ImageStatus {
  unreviewed
  allowed
  blocked
}

enum ReportType {
  spam
  harassment
  impersonation
  inappropriateContent
  misinformation
}

enum SessionType {
  user
  staff
}

enum EmailChallengeStatus {
  incomplete
  successful
  failed
}

enum EmailChallengeType {
  email
  studentEmail
}

enum ImageType {
  post
  profile
}